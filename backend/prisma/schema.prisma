generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email        String    @unique @db.VarChar(255) @map("email")
  username     String?   @unique @db.VarChar(50) @map("username")
  passwordHash String?   @db.VarChar(255) @map("password_hash")
  googleId     String?   @unique @db.VarChar(255) @map("google_id")
  avatarUrl    String?   @map("avatar_url")
  language     String?   @default("fr") @db.VarChar(5)
  roles        String[]  @default(["user"])
  createdAt    DateTime? @default(now()) @db.Timestamp(6) @map("created_at")
  updatedAt    DateTime? @default(now()) @db.Timestamp(6) @map("updated_at")

  refreshTokens          RefreshToken[]
  savedWatchlists        SavedWatchlist[]
  watchlistPositions     UserWatchlistPosition[]
  collaborativeWatchlists WatchlistCollaborator[]
  watchlistLikes         WatchlistLike[]
  watchlists             Watchlist[]

  @@index([email], map: "idx_users_email")
  @@index([googleId], map: "idx_users_google_id")
  @@map("users")
}

model RefreshToken {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String?   @db.Uuid @map("user_id")
  tokenHash String    @db.VarChar(255) @map("token_hash")
  userAgent String?   @map("user_agent")
  issuedAt  DateTime? @default(now()) @db.Timestamp(6) @map("issued_at")
  expiresAt DateTime? @db.Timestamp(6) @map("expires_at")

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([userId], map: "idx_refresh_tokens_user")
  @@map("refresh_tokens")
}

model Watchlist {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ownerId      String?   @db.Uuid @map("owner_id")
  name         String    @db.VarChar(255)
  description  String?
  imageUrl     String?   @map("image_url")
  thumbnailUrl String?   @map("thumbnail_url")
  isPublic     Boolean?  @default(false) @map("is_public")
  genres       String[]
  position     Int?      @default(0)
  createdAt    DateTime? @default(now()) @db.Timestamp(6) @map("created_at")
  updatedAt    DateTime? @default(now()) @db.Timestamp(6) @map("updated_at")

  owner         User?                   @relation(fields: [ownerId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  items         WatchlistItem[]
  collaborators WatchlistCollaborator[]
  likedBy       WatchlistLike[]
  savedBy       SavedWatchlist[]
  positions     UserWatchlistPosition[]

  @@index([ownerId], map: "idx_watchlists_owner")
  @@map("watchlists")
}

model WatchlistItem {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  watchlistId      String?   @db.Uuid @map("watchlist_id")
  tmdbId           Int       @map("tmdb_id")
  mediaType        String    @db.VarChar(10) @map("media_type")
  title            String?   @db.VarChar(255)
  posterPath       String?   @map("poster_path")
  backdropPath     String?   @map("backdrop_path")
  overview         String?
  releaseDate      DateTime? @db.Date @map("release_date")
  voteAverage      Decimal?  @db.Decimal(3, 1) @map("vote_average")
  runtime          Int?
  numberOfSeasons  Int?      @map("number_of_seasons")
  numberOfEpisodes Int?      @map("number_of_episodes")
  platformList     Json?     @default("[]") @map("platform_list")
  position         Int?      @default(0)
  addedAt          DateTime? @default(now()) @db.Timestamp(6) @map("added_at")

  watchlist Watchlist? @relation(fields: [watchlistId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([watchlistId, tmdbId, mediaType])
  @@index([watchlistId], map: "idx_watchlist_items_watchlist")
  @@map("watchlist_items")
}

model WatchlistCollaborator {
  watchlistId String    @db.Uuid @map("watchlist_id")
  userId      String    @db.Uuid @map("user_id")
  addedAt     DateTime? @default(now()) @db.Timestamp(6) @map("added_at")

  watchlist Watchlist @relation(fields: [watchlistId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([watchlistId, userId])
  @@map("watchlist_collaborators")
}

model WatchlistLike {
  watchlistId String    @db.Uuid @map("watchlist_id")
  userId      String    @db.Uuid @map("user_id")
  likedAt     DateTime? @default(now()) @db.Timestamp(6) @map("liked_at")

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  watchlist Watchlist @relation(fields: [watchlistId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([watchlistId, userId])
  @@map("watchlist_likes")
}

model SavedWatchlist {
  userId      String    @db.Uuid @map("user_id")
  watchlistId String    @db.Uuid @map("watchlist_id")
  savedAt     DateTime? @default(now()) @db.Timestamp(6) @map("saved_at")

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  watchlist Watchlist @relation(fields: [watchlistId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([userId, watchlistId])
  @@map("saved_watchlists")
}

model UserWatchlistPosition {
  userId      String   @db.Uuid @map("user_id")
  watchlistId String   @db.Uuid @map("watchlist_id")
  position    Int      @default(0)
  addedAt     DateTime @default(now()) @db.Timestamptz(6) @map("added_at")

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "user_watchlist_positions_user_id_foreign")
  watchlist Watchlist @relation(fields: [watchlistId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "user_watchlist_positions_watchlist_id_foreign")

  @@id([userId, watchlistId])
  @@index([userId, position], map: "user_watchlist_positions_user_id_position_index")
  @@map("user_watchlist_positions")
}

model ApiCache {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  requestUrl   String    @unique @db.VarChar(2048) @map("request_url")
  responseData Json      @map("response_data")
  cachedAt     DateTime? @default(now()) @db.Timestamp(6) @map("cached_at")
  expiresAt    DateTime  @db.Timestamp(6) @map("expires_at")

  @@index([expiresAt], map: "idx_api_caches_expires")
  @@index([requestUrl], map: "idx_api_caches_url")
  @@map("api_caches")
}
